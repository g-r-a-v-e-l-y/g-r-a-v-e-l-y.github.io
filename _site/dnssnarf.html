<!DOCTYPE html>
<html lang="en"  dir="auto" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>dnssnarf - gimme pizza slow (high quality)</title>
<meta property="og:title" content="dnssnarf - gimme pizza slow (high quality)">
<link rel="stylesheet" href="/css/style.css?v=1734722231">
<script src="/js/scripts.js?v=1734722231"></script>
<meta name="description" content="{{ content|truncate(160) }}">
<link rel="canonical" href="https://www.gravely.pizza/dnssnarf" />
<meta name="generator" content="Eleventy v2.0.1">
<link rel="icon" href="/favicon.ico" sizes="any">
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="manifest" href="/manifest.webmanifest">
<link rel="alternate" type="application/rss+xml"  title="gimme pizza slow (high quality) RSS feed (excerpts)" href="/excerpts.xml" />
<link rel="alternate" type="application/rss+xml"  title="gimme pizza slow (high quality) RSS feed (full articles)" href="/full.xml" />
<link rel="alternate" type="application/json" title="gimme pizza slow (high quality) JSON feed (excerpts)" href="/excerpts.json">
<link rel="alternate" type="application/json" title="gimme pizza slow (high quality) JSON feed (full articles)" href="/full.json">
<meta property="og:site_name" content="gimme pizza slow (high quality)" />
<meta property="og:title" content="">
<meta property="og:url" content="https://www.gravely.pizza/dnssnarf.html">
<meta property="og:type" content="article">
<meta property="og:image" content="https://www.gravely.pizza/images/share-1200x600.jpg">
<meta property="article:published_time" content="2009-12-05T19:59:00.000Z" />
<meta property="article:modified_time" content="2009-12-05T19:59:00.000Z" />
<meta property="twitter:image" content="https://www.gravely.pizza/images/share-1200x600.jpg">
<meta property="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@your_twitter_handle" />
<meta name="fediverse:creator" content="@gravely@mastodon.social" />
<link rel="me" href="https://mastodon.social/@gravely" title="@gravely@mastodon.social" />

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": "dnssnarf",
        "image": ["https://www.gravely.pizza/images/share-1200x600.jpg"],
        "author": {
            "@type": "Person",
            "name": "gravely"
        },
        "mainEntityOfPage": "https://www.gravely.pizza/dnssnarf.html",
        "datePublished": "2011-10-09T03:43:00.000Z",
        "description": "{{ content|truncate(160) }}"
    }
</script>


  </head>
  <body>
    <a href="#main" id="skipToMain" class="skip-link">Skip to main content</a>
<header class="header">
  <input class="menu-btn" type="checkbox" id="menu-btn">
<label class="hamburger" tabindex="0" for="menu-btn">
  <span></span>
</label>
  <div class="main-nav">
  <ul class="site-links">
  
  <li>
    <a href="/">
      About
    </a>
  </li>
  
  <li>
    <a href="/blog.html">
      Blog
    </a>
  </li>
  
  <li>
    <a href="/my-archives/">
      Archive
    </a>
  </li>
  
  <li>
    <a href="/links/">
      Links
    </a>
  </li>
  
  <li>
    <a href="/favorites/">
      Favorites
    </a>
  </li>
  
  <li>
    <a href="/subscribe/">
      Subscribe
    </a>
  </li>
  
  <li class="theme-switcher">
    <a href=""><svg class="dark-toggle" viewBox="0 0 455 455" xmlns="http://www.w3.org/2000/svg">
<title>Dark mode switch icon</title>
<polygon points="320.18 162.7 280.63 171.05 307.72 201.05 303.44 241.24 340.34 224.75 377.24 241.24 372.96 201.05 400.05 171.05 360.5 162.7 340.34 127.67"/>
<polygon points="440 325.68 414.09 320.21 400.88 297.25 387.68 320.21 361.77 325.68 379.51 345.33 376.71 371.66 400.88 360.86 425.06 371.66 422.25 345.33"/>
<path d="m218 227.5c0-89.167 51.306-166.34 126-203.64-30.557-15.26-65.022-23.86-101.5-23.86-125.64 0-227.5 101.86-227.5 227.5s101.86 227.5 227.5 227.5c36.478 0 70.943-8.6 101.5-23.86-74.694-37.302-126-114.47-126-203.64z"/>
</svg>

  <svg class="light-toggle" viewBox="0 0 612 612" xmlns="http://www.w3.org/2000/svg"><title>Light mode switch icon</title><path d="m306 149.34c-86.382 0-156.66 70.278-156.66 156.66 0 86.382 70.278 156.66 156.66 156.66s156.66-70.278 156.66-156.66c0-86.384-70.278-156.66-156.66-156.66z"/><path d="m274.19 117.28h63.612c5.032 0 9.356-2.101 11.863-5.763 2.508-3.662 2.9-8.453 1.079-13.146l-34.999-90.112c-2.789-7.184-7.305-8.256-9.749-8.256s-6.96 1.073-9.749 8.255l-35 90.114c-1.821 4.692-1.427 9.482 1.079 13.145 2.507 3.663 6.832 5.763 11.864 5.763z"/><path d="m337.81 494.72h-63.612c-5.032 0-9.357 2.102-11.863 5.764-2.506 3.663-2.9 8.453-1.079 13.145l34.999 90.114c2.789 7.182 7.305 8.254 9.749 8.254s6.96-1.072 9.749-8.254l34.999-90.115c1.821-4.69 1.429-9.48-1.079-13.144-2.507-3.662-6.831-5.764-11.863-5.764z"/><path d="m127.54 190.82c2.412 5.477 7.028 8.746 12.348 8.746 3.644 0 7.257-1.608 10.174-4.526l44.981-44.98c3.558-3.558 5.13-8.102 4.312-12.466-0.819-4.362-3.928-8.028-8.532-10.056l-88.467-38.973c-2.233-0.983-4.336-1.482-6.25-1.482-3.201 0-5.959 1.415-7.568 3.882-1.357 2.081-2.454 5.747 0.031 11.389l38.971 88.466z"/><path d="m484.46 421.18c-2.412-5.477-7.027-8.746-12.346-8.746-3.645 0-7.259 1.609-10.177 4.527l-44.981 44.98c-3.558 3.559-5.13 8.104-4.312 12.466s3.929 8.028 8.532 10.055l88.466 38.974c2.233 0.983 4.336 1.482 6.25 1.482 3.201 0 5.959-1.417 7.568-3.882 1.358-2.083 2.455-5.748-0.03-11.389l-38.97-88.467z"/><path d="m461.94 195.04c2.918 2.918 6.532 4.526 10.176 4.526 5.319 0 9.934-3.269 12.348-8.746l38.972-88.465c2.486-5.643 1.389-9.308 0.031-11.389-1.609-2.467-4.367-3.882-7.568-3.882-1.914 0-4.017 0.499-6.251 1.483l-88.466 38.97c-4.604 2.029-7.715 5.694-8.532 10.057-0.818 4.363 0.754 8.908 4.312 12.466l44.978 44.98z"/><path d="m150.06 416.96c-2.918-2.918-6.532-4.527-10.177-4.527-5.319 0-9.934 3.269-12.346 8.746l-38.972 88.465c-2.486 5.643-1.389 9.308-0.031 11.39 1.609 2.466 4.368 3.882 7.568 3.882 1.914 0 4.017-0.499 6.251-1.484l88.466-38.972c4.604-2.028 7.715-5.694 8.532-10.056 0.818-4.362-0.753-8.907-4.312-12.466l-44.979-44.978z"/><path d="m603.74 296.25-90.111-34.996c-1.942-0.755-3.896-1.137-5.806-1.137-7.593 0-13.104 5.921-13.104 14.078l1e-3 63.613c0 8.157 5.511 14.078 13.104 14.078 1.912 0 3.866-0.382 5.806-1.136l90.112-34.999c7.182-2.79 8.254-7.306 8.254-9.751 0-2.443-1.075-6.961-8.256-9.75z"/><path d="m104.17 351.89c7.594 0 13.106-5.921 13.106-14.078v-63.613c0-8.157-5.511-14.078-13.106-14.078-1.912 0-3.864 0.382-5.805 1.136l-90.113 34.998c-7.182 2.789-8.255 7.305-8.255 9.75 0 2.444 1.072 6.96 8.255 9.752l90.111 34.996c1.942 0.754 3.895 1.137 5.807 1.137z"/></svg></a>
  </li>
  </ul>
  <div class="site-logo">
    <a href="/" title="gimme pizza slow (high quality) - Main page">
      
  <span class="site_title">gimme pizza slow (high quality)</span>

    </a>
  </div>
</div>

</header>

    <div id="main" class="container">
      

<div class="reading-progress-bar"></div>


<article class="single-article">

  

  <header>
    <h1>dnssnarf</h1>
  </header>
  <div class="top-meta">
  <time>5 Dec 2009</time>
  
  <span class="separator">, </span>
  <span data-tooltip="837 words" class="tooltip-bottom reading-time">5 min read</span>
  
</div>
  
  <p>Domain Name System (DNS) traffic is inherently timely. Responses from DNS servers are expected to change from one minute to the next. So many important application layer protocols leverage DNS, and it is so pervasively necessary for even basic Internet access, and it is such a simple behavior indicator, that it only makes sense to log the crap out of it. In minutiae.</p>
<p>Yet, it seems like DNS logging is still one of those everyone-rolls-their-own efforts. And fewer still log DNS from a sniffing sensor, instead trusting their DNS servers. I hate rolling my own, and I don’t trust DNS servers.</p>
<p>I’ve borrowed a healthy dozen or more security monitoring ideas from <a href="http://www.aplura.com/about.html">Sean Wilkerson</a>, so while he was still on stage after a talk at <a href="http://www.dojosec.com/">DojoSec</a>, I re-raised my DNS Logging plight. I’d hoped he knew of a tool, or could use the microphone, video stream, and audience to ask that someone create one. Actually, I didn’t hope, I specifically said “And hey, if anyone is listening, this needs to exist. If you can create, you are obligated.” or something along those lines.</p>
<p>I wasn’t looking for an analysis tool, or a log parser, or an IDS signature. I just wanted the equivalent of the many <em>snarf</em> programs in Dug Song’s <a href="http://monkey.org/~dugsong/dsniff/">dsniff</a> package. It had to be lightweight, reliably parse all application traffic of the DNS protocol, and simply log it. Dsniff already does that for HTTP, NFS, SMTP, IRC, and many instant messenger protocols, and it can <em>spoof</em> DNS, but has nothing for passive DNS monitoring.</p>
<p>It worked! Sort of.</p>
<p>Christopher McBee was in the audience, and he knew that Python and Scapy would probably be capable. In twenty minutes, <a href="http://vrt-sourcefire.blogspot.com/2009/05/dojosec-and-dnssnarf.html">he had a working DNS logger</a>. Awesome.</p>
<p>It didn’t log minutiae, but that wasn’t Scapy’s fault. It didn’t log TCP, and that is still Scapy’s fault.</p>
<p>Spurred by Christopher’s work, I dove into Python and <a href="http://github.com/grantstavely/Dnssnarf/blob/master/dnssnarf.py">finished it</a> to my original spec, mostly.</p>
<pre><code>&gt; dnssnarf --help usage: dnssnarf [options] Log DNS messages with Python and Scapy options: --version show program's version number and exit -h, --help show this help message and exit -s, --syslog write to syslog -f FACILITY, --facility=FACILITY Syslog facility. Defaults: 'user') -p PRIORITY, --priority=PRIORITY Syslog priority. Defaults: 'info' -i INTERFACE, --interface=INTERFACE listen on INTERFACE -q, --quiet quiet output -b BPF, --bpf=BPF BPF to apply to scapy sniffer. Default: 'port 53 and udp' -n, --named named query log format -d, --debug Print additional debugging information
</code></pre>
<p>It doesn’t understand TCP DNS, because Scapy doesn’t, and I am not smart enough to fix that.</p>
<p>Output looks like this by default:</p>
<pre><code>Fri Dec 4 06:24:56 2009 UDP session: 44167 client: 192.168.1.1:59634 server: 69.63.185.11:53 query: login.facebook.com. class: IN type: A recurse: no Fri Dec 4 06:24:56 2009 UDP session: 44167 client: 69.63.185.11:53 server: 192.168.1.1:59634 query: login.facebook.com. class: IN type: A recurse: no Fri Dec 4 06:24:56 2009 UDP session: 44167 server: 69.63.185.11:53 client: 192.168.1.1:59634 response: 69.63.181.22 ok type: A ttl: 30L len: 4
</code></pre>
<p>So then I’m validating it against tcpdump. tcpdump already does what I want. And it isn’t Python. It’s fast. Silly us.</p>
<p>Here’s tcpdump with me running ‘host grantstavely.com’ in another window.</p>
<pre><code>grantstavely:~ grant$ sudo tcpdump -i en1 -nn -tttt port 53 tcpdump: verbose output suppressed, use -v or -vv for full protocol decode listening on en1, link-type EN10MB (Ethernet), capture size 65535 bytes 2009-12-04 06:32:32.368184 IP 192.168.1.25.61686 &gt; 192.168.1.4.53: 50950+ A? grantstavely.com. (34) 2009-12-04 06:32:32.373623 IP 192.168.1.4.53 &gt; 192.168.1.25.61686: 50950 1/0/0 A 75.101.142.201 (50) 2009-12-04 06:32:32.374358 IP 192.168.1.25.64909 &gt; 192.168.1.4.53: 44029+ AAAA? grantstavely.com. (34) 2009-12-04 06:32:32.376867 IP 192.168.1.4.53 &gt; 192.168.1.25.64909: 44029 0/0/0 (34) 2009-12-04 06:32:32.377112 IP 192.168.1.25.57526 &gt; 192.168.1.4.53: 55171+ MX? grantstavely.com. (34) 2009-12-04 06:32:32.394888 IP 192.168.1.4.53 &gt; 192.168.1.25.57526: 55171 8/0/0 MX smtp7.grantstavely.com. 10, MX smtp4.grantstavely.com. 10, MX smtp6.grantstavely.com. 10, MX smtp.grantstavely.com. 0, MX smtp8.grantstavely.com. 10, MX smtp2.grantstavely.com. 5, MX smtp3.grantstavely.com. 5, MX smtp5.grantstavely.com. 10 (209)
</code></pre>
<p>Under my nose!</p>
<p>Actually, tcpdump isn’t showing us ~transaction ID numbers~, TTLs, or LENs, which is a bummer. So dnssnarf still has it’s uses after all.</p>

</article>

<div class="post-navigation">
  <ul>
    <li>
      
      <a href="/shmoocon-2010-advice.html">
        <span class="headline">← Newer article</span>
        <span class="title">Shmoocon 2010 Advice</span>
      </a>
      
    </li>
    <li>
      
      <a href="/trstus.html">
        <span class="headline">Older article →</span>
        <span class="title">trst.us</span>
      </a>
      
    </li>
  </ul>
</div>

<div class="scroll-up-arrow" tabindex="0">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><g><path class="fillable" d="M990,699.9c0,8.1,0,16.3-8.1,24.4c-16.3,16.3-40.7,16.3-56.9,0L502,350.2L79.1,732.4c-16.3,16.3-40.7,16.3-56.9,0c-16.3-16.3-16.3-40.7,0-56.9l447.3-406.6c24.4-16.3,40.7-16.3,56.9-8.1l447.3,406.6C981.9,675.5,990,691.8,990,699.9z"></path></g></svg>

</div>

      <footer class="footer">
  <div class="container">
    <div class="links">
  
<ul>

</ul>

</div>
    <div class="copyright">
  &copy; 1999-2024 <a href="https://www.gravely.pizza/">gravely</a>
</div>
  </div>
</footer>

    </div>
  </body>
</html>