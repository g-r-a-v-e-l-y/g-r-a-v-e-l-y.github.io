<!DOCTYPE html>
<html lang="en"  dir="auto" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>capture - a script for analysts and incident handlers - gimme pizza slow (high quality)</title>
<meta property="og:title" content="capture - a script for analysts and incident handlers - gimme pizza slow (high quality)">
<link rel="stylesheet" href="/css/style.css?v=1734730330">
<script src="/js/scripts.js?v=1734730330"></script>
<meta name="description" content="{{ content|truncate(160) }}">
<link rel="canonical" href="https://www.gravely.pizza/capture-a-script-for-analysts-and-incident-handlers" />
<meta name="generator" content="Eleventy v2.0.1">
<link rel="icon" href="/favicon.ico" sizes="any">
<link rel="icon" href="/favicon.svg" type="image/svg+xml">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="manifest" href="/manifest.webmanifest">
<link rel="alternate" type="application/rss+xml"  title="gimme pizza slow (high quality) RSS feed (excerpts)" href="/excerpts.xml" />
<link rel="alternate" type="application/rss+xml"  title="gimme pizza slow (high quality) RSS feed (full articles)" href="/full.xml" />
<link rel="alternate" type="application/json" title="gimme pizza slow (high quality) JSON feed (excerpts)" href="/excerpts.json">
<link rel="alternate" type="application/json" title="gimme pizza slow (high quality) JSON feed (full articles)" href="/full.json">
<meta property="og:site_name" content="gimme pizza slow (high quality)" />
<meta property="og:title" content="">
<meta property="og:url" content="https://www.gravely.pizza/capture.html">
<meta property="og:type" content="article">
<meta property="og:image" content="https://www.gravely.pizza/images/share-1200x600.jpg">
<meta property="article:published_time" content="2009-02-18T05:09:00.000Z" />
<meta property="article:modified_time" content="2009-02-18T05:09:00.000Z" />
<meta property="twitter:image" content="https://www.gravely.pizza/images/share-1200x600.jpg">
<meta property="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="@your_twitter_handle" />
<meta name="fediverse:creator" content="@gravely@mastodon.social" />
<link rel="me" href="https://mastodon.social/@gravely" title="@gravely@mastodon.social" />

<script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "Article",
        "headline": "capture - a script for analysts and incident handlers",
        "image": ["https://www.gravely.pizza/images/share-1200x600.jpg"],
        "author": {
            "@type": "Person",
            "name": "gravely"
        },
        "mainEntityOfPage": "https://www.gravely.pizza/capture.html",
        "datePublished": "2011-10-09T03:43:00.000Z",
        "description": "{{ content|truncate(160) }}"
    }
</script>


  </head>
  <body>
    <a href="#main" id="skipToMain" class="skip-link">Skip to main content</a>
<header class="header">
  <input class="menu-btn" type="checkbox" id="menu-btn">
<label class="hamburger" tabindex="0" for="menu-btn">
  <span></span>
</label>
  <div class="main-nav">
  <ul class="site-links">
  
  <li>
    <a href="/">
      About
    </a>
  </li>
  
  <li>
    <a href="/blog.html">
      Blog
    </a>
  </li>
  
  <li>
    <a href="/links/">
      Links
    </a>
  </li>
  
  <li>
    <a href="/my-archives/">
      Archive
    </a>
  </li>
  
  <li>
    <a href="/favorites/">
      Favorites
    </a>
  </li>
  
  <li>
    <a href="/subscribe/">
      Subscribe
    </a>
  </li>
  
  <li class="theme-switcher">
    <a href=""><svg class="dark-toggle" viewBox="0 0 455 455" xmlns="http://www.w3.org/2000/svg">
<title>Dark mode switch icon</title>
<polygon points="320.18 162.7 280.63 171.05 307.72 201.05 303.44 241.24 340.34 224.75 377.24 241.24 372.96 201.05 400.05 171.05 360.5 162.7 340.34 127.67"/>
<polygon points="440 325.68 414.09 320.21 400.88 297.25 387.68 320.21 361.77 325.68 379.51 345.33 376.71 371.66 400.88 360.86 425.06 371.66 422.25 345.33"/>
<path d="m218 227.5c0-89.167 51.306-166.34 126-203.64-30.557-15.26-65.022-23.86-101.5-23.86-125.64 0-227.5 101.86-227.5 227.5s101.86 227.5 227.5 227.5c36.478 0 70.943-8.6 101.5-23.86-74.694-37.302-126-114.47-126-203.64z"/>
</svg>

  <svg class="light-toggle" viewBox="0 0 612 612" xmlns="http://www.w3.org/2000/svg"><title>Light mode switch icon</title><path d="m306 149.34c-86.382 0-156.66 70.278-156.66 156.66 0 86.382 70.278 156.66 156.66 156.66s156.66-70.278 156.66-156.66c0-86.384-70.278-156.66-156.66-156.66z"/><path d="m274.19 117.28h63.612c5.032 0 9.356-2.101 11.863-5.763 2.508-3.662 2.9-8.453 1.079-13.146l-34.999-90.112c-2.789-7.184-7.305-8.256-9.749-8.256s-6.96 1.073-9.749 8.255l-35 90.114c-1.821 4.692-1.427 9.482 1.079 13.145 2.507 3.663 6.832 5.763 11.864 5.763z"/><path d="m337.81 494.72h-63.612c-5.032 0-9.357 2.102-11.863 5.764-2.506 3.663-2.9 8.453-1.079 13.145l34.999 90.114c2.789 7.182 7.305 8.254 9.749 8.254s6.96-1.072 9.749-8.254l34.999-90.115c1.821-4.69 1.429-9.48-1.079-13.144-2.507-3.662-6.831-5.764-11.863-5.764z"/><path d="m127.54 190.82c2.412 5.477 7.028 8.746 12.348 8.746 3.644 0 7.257-1.608 10.174-4.526l44.981-44.98c3.558-3.558 5.13-8.102 4.312-12.466-0.819-4.362-3.928-8.028-8.532-10.056l-88.467-38.973c-2.233-0.983-4.336-1.482-6.25-1.482-3.201 0-5.959 1.415-7.568 3.882-1.357 2.081-2.454 5.747 0.031 11.389l38.971 88.466z"/><path d="m484.46 421.18c-2.412-5.477-7.027-8.746-12.346-8.746-3.645 0-7.259 1.609-10.177 4.527l-44.981 44.98c-3.558 3.559-5.13 8.104-4.312 12.466s3.929 8.028 8.532 10.055l88.466 38.974c2.233 0.983 4.336 1.482 6.25 1.482 3.201 0 5.959-1.417 7.568-3.882 1.358-2.083 2.455-5.748-0.03-11.389l-38.97-88.467z"/><path d="m461.94 195.04c2.918 2.918 6.532 4.526 10.176 4.526 5.319 0 9.934-3.269 12.348-8.746l38.972-88.465c2.486-5.643 1.389-9.308 0.031-11.389-1.609-2.467-4.367-3.882-7.568-3.882-1.914 0-4.017 0.499-6.251 1.483l-88.466 38.97c-4.604 2.029-7.715 5.694-8.532 10.057-0.818 4.363 0.754 8.908 4.312 12.466l44.978 44.98z"/><path d="m150.06 416.96c-2.918-2.918-6.532-4.527-10.177-4.527-5.319 0-9.934 3.269-12.346 8.746l-38.972 88.465c-2.486 5.643-1.389 9.308-0.031 11.39 1.609 2.466 4.368 3.882 7.568 3.882 1.914 0 4.017-0.499 6.251-1.484l88.466-38.972c4.604-2.028 7.715-5.694 8.532-10.056 0.818-4.362-0.753-8.907-4.312-12.466l-44.979-44.978z"/><path d="m603.74 296.25-90.111-34.996c-1.942-0.755-3.896-1.137-5.806-1.137-7.593 0-13.104 5.921-13.104 14.078l1e-3 63.613c0 8.157 5.511 14.078 13.104 14.078 1.912 0 3.866-0.382 5.806-1.136l90.112-34.999c7.182-2.79 8.254-7.306 8.254-9.751 0-2.443-1.075-6.961-8.256-9.75z"/><path d="m104.17 351.89c7.594 0 13.106-5.921 13.106-14.078v-63.613c0-8.157-5.511-14.078-13.106-14.078-1.912 0-3.864 0.382-5.805 1.136l-90.113 34.998c-7.182 2.789-8.255 7.305-8.255 9.75 0 2.444 1.072 6.96 8.255 9.752l90.111 34.996c1.942 0.754 3.895 1.137 5.807 1.137z"/></svg></a>
  </li>
  </ul>
  <div class="site-logo">
    <a href="/" title="gimme pizza slow (high quality) - Main page">
      
  <span class="site_title">gimme pizza slow (high quality)</span>

    </a>
  </div>
</div>

</header>

    <div id="main" class="container">
      

<div class="reading-progress-bar"></div>


<article class="single-article">

  

  <header>
    <h1>capture - a script for analysts and incident handlers</h1>
  </header>
  <div class="top-meta">
  <time>18 Feb 2009</time>
  
  <span class="separator">, </span>
  <span data-tooltip="1329 words" class="tooltip-bottom reading-time">7 min read</span>
  
</div>
  
  <p>I’ve found this script very useful for network security monitoring, incident handling, and analyst training.</p>
<h3 id="the-problems">The problem(s)</h3>
<p>Frequently, security analysts kick off tcpdump full packet captures on unix servers with tapped interfaces at trust zone perimeters which they leave running in the background. Often this is done in a hurry in order to catch something before it disappears, and just as often, the capture is left running for a few days, weeks, or even months at a time.</p>
<p>Unfortunately, this leaves dozens of tcpdump capture files strewn about home directories, all of them poorly named and all too often left running and forgotten. Which ones are junk? Which can be archived or deleted? What a mess!</p>
<h3 id="the-horror">The Horror</h3>
<p>And this is even more problematic for those of you practicing <a href="http://taosecurity.blogspot.com/">network security monitoring</a> with <a href="http://www.snort.org/users/roesch/Site/Daemonlogger/Daemonlogger.html">daemonlogger</a> or a similar rolling full packet capture daemon.</p>
<p>How can an analyst dig through hundreds of large pcap files for just the traffic they want? Whether it is 50Gb of accumulated network traffic that left a T1 connection over the past week, or that left an OC3 connection in the past 15 hours, it is too much to pull a file at a time, even <em>with</em> a guess where to start. These nsm daemons can easily generate a Gb of data every minute! Neither tcpdump -r nor daemonlogger -r accept wild cards. Hunting for an event one file at a time? No thanks.</p>
<p>Who wants to mess with <em>ps</em>, <em>grep</em>, and <em>kill</em>, much less the oft repeated <em>-nn -s 1516 -i interface</em> during incident handling?</p>
<h3 id="a-solution">A solution</h3>
<p>I created a perl script to manage starting, monitoring, and stopping all packet captures - live or from active daemonlogger pcap files. I retrained all my analysts to use it. I updated my sensor monitoring scripts to start using it too.</p>
<p>I think this would be useful at ISP’s, .edu’s, and enterprise organizations so I refactored what my team and I have been using for the past year to make it significantly better. Time to release it!</p>
<h3 id="capture">capture</h3>
<pre><code>&gt; capture
Usage: capture [-h?lsmv] [r|R] [-a analyst -d 'quoted description' -e 'quoted expression'] [-f filter]
</code></pre>
<h3 id="starting-captures">Starting captures</h3>
<p>Script the repetitive stuff, force the informative and useful stuff, and prevent mistakes.</p>
<pre><code>&gt; sudo capture -a grant -d 'traffic to grantstavely.com' -e 'host 205.134.166.178'
Password:
Started: grant_traffic.to.grantstavely.com_Tue.Feb17.2009-20.20.22.UTC_1234902022_.pcap
</code></pre>
<h3 id="monitoring-captures">Monitoring captures</h3>
<pre><code>&gt; sudo capture -l
grant Tue Feb 17 15:20:22 2009 traffic to grantstavely com
will Tue Feb 17 15:24:05 2009 irc traffic
philip Tue Feb 17 15:24:41 2009 strange malware on 8081
</code></pre>
<p>Too many, I’m checking on my own captures only!</p>
<pre><code>&gt; sudo capture -lf grant
grant Tue Feb 17 15:20:22 2009 traffic to grantstavely com
</code></pre>
<p>Need more detail?</p>
<pre><code>&gt; sudo capture -lv
Analyst: grant
Size (bytes): 720.00 KB
Started: Tue Feb 17 15:20:56 2009
Last Modified: Tue Feb 17 15:21:31 2009
Last Accessed: Tue Feb 17 15:20:56 2009
Last Changed: Tue Feb 17 15:21:31 2009
Description: traffic to grantstavely com
Expression: host 75.101.142.201
Capture File:
/Users/grant/captures/grant_traffic.to.grantstavely.com_Tue.Feb17.2009-20.20.56.UTC_1234902056_.pcap
</code></pre>
<h3 id="stopping-captures">Stopping Captures</h3>
<pre><code>&gt; sudo capture -svf grant
Analyst: grant
Size (bytes): 720.00 KB
Started: Tue Feb 17 15:20:56 2009
Last Modified: Tue Feb 17 15:21:31 2009
Last Accessed: Tue Feb 17 15:20:56 2009
Last Changed: Tue Feb 17 15:21:31 2009
Description: traffic to grantstavely com
Expression: host 75.101.142.201
Capture File:
/Users/grant/captures/grant_traffic.to.grantstavely.com_Tue.Feb17.2009-20.20.56.UTC_1234902056_.pcap

Capture file info:
File name: grant_traffic.to.grantstavely.com_Tue.Feb17.2009-20.20.56.UTC_1234902056_.pcap
File type: Wireshark/tcpdump/... - libpcap
File encapsulation: Ethernet
Number of packets: 2778
File size: 1869006 bytes
Data size: 1824534 bytes
Capture duration: 12.070557 seconds
Start time: Tue Feb 17 15:48:22 2009
End time: Tue Feb 17 15:48:34 2009
Data rate: 151155.74 bytes/s
Data rate: 1209245.95 bits/s
Average packet size: 656.78 bytes
</code></pre>
<h3 id="daemonlogger-data">Daemonlogger Data</h3>
<p>If you have a directory of daemonlogger pcaps, point <em>capture</em> at them with the same standard syntax and it will run through each file, gradually merging only the data you want into a single manageable pcap.</p>
<p>Note that <em>capture</em> maintains a soft link to the currently merged temp file using the name of the final target file so that you can start performing analysis right away.</p>
<pre><code>&gt; capture -ra grant -d 'historical traffic to gs.com' -e 'host 75.101.142.201'
Generating grant_historical.traffic.to.gs.com_Tue.Feb17.2009-21.12.57.UTC_1234905177_.past.pcap
Currently Processing: Tue Feb 17 05:23:45 2009
</code></pre>
<p>Or do both - start a new live capture and grab the same data from daemonlogger archived pcaps.</p>
<pre><code>&gt; capture -Ra grant -d 'historical traffic to gs.com' -e 'host 75.101.142.201'
Started: grant_historical.traffic.to.gs.com_Tue.Feb17.2009-21.12.57.UTC_1234905177_.pcap
Generating grant_historical.traffic.to.gs.com_Tue.Feb17.2009-21.12.57.UTC_1234905177_.past.pcap
Currently Processing: Tue Feb 17 05:23:45 2009
</code></pre>
<p>While running, the ‘Currently Processing’ line will maintain a listing of how far through daemonlogger data the process is. From another console, the same is available to other analysts</p>
<pre><code>&gt; capture -lv
Analyst: will
Size (bytes): 60.00 KB
Started: Tue Feb 17 16:21:02 2009
Last Modified: Tue Feb 17 16:21:15 2009
Last Accessed: Tue Feb 17 16:21:03 2009
Last Changed: Tue Feb 17 16:21:15 2009
Description: dns traffic
Expression: port 53
Capture File: /Users/grant/captures/will_dns.traffic_Tue.Feb17.2009-21.21.02.UTC_1234905662_.pcap

Analyst: grant
Size (bytes): 0 Bytes
Progress: Tue Feb 17 10:03:01 2009
Description: historical traffic to gs com
Expression: host 75.101.142.201
Capture File:
/Users/grant/captures/grant.processing.4958.1234882981_historical.traffic.to.gs.com_Tue.Feb17.2009-21.12.57.UTC_1234905177_.past.pcap
</code></pre>
<h3 id="additional-uses">Additional uses</h3>
<p><em>capture</em> takes full advantage of syslog, so that you can validate what analysts did what, and when.</p>
<p>You could schedule regular e-mail to management to validate what captures are running, or were run, per user, per day, and so on.</p>
<p>If short on disk space, leave only individual long running captures going against specific hosts, add them to start with init.</p>
<p><em>capture</em> has support for hashing completed capture files, use the hashes later to validate your data.</p>
<p>Use shell aliasing to create a quick start ‘cap $1 $2 $3’ alias which defaults to one of the operations cap normally requires -a, -d, and -e to perform</p>
<h3 id="requirements">Requirements</h3>
<p>You must have: perl, a few perl modules, and tcpdump. You also need capinfos and mergecap, both of which are part of most wireshark and tshark distributions.</p>
<p>I suggest that analysts run <em>capture</em> on systems using sudo.</p>
<p><em>capture</em> has been tested and run successfully on linux, bsd, and MacOSX systems. You should review the source to configure the handful of options available before testing.</p>
<h3 id="future-plans">Future plans</h3>
<ul>
<li>~Run through a directory of pcaps w/ mergecap~</li>
<li>~Integrate daemonlogger~</li>
<li>~Better privilege seperation~</li>
<li>~Built in man page~</li>
<li>~Functional option combinations and errors~</li>
<li>~FreeBSD and OSX support~</li>
<li>~More useful verbose output~</li>
<li>More user testing</li>
<li>A ‘speed start’ no-flag syntax for starting captures rapidly</li>
<li>~Proper SIGNAL handling to stop --read jobs~</li>
<li>/etc/ file usage to replace script header configuration</li>
<li>Assumption defaults (friendly handler name interpreting, auto descriptions using bpf, etc)</li>
<li>Suggested alternate resources; web links, dns information, argus queries, ids urls, extensible whatever</li>
<li>A web front end</li>
<li>Just kidding about the web front end</li>
<li>Specific script targeted output</li>
<li>Capture monitor and alerting</li>
<li>Better facilitation of metrics</li>
<li>Threading to improve speed of daemonlogger filtering</li>
</ul>
<h3 id="download">Download</h3>
<p>Capture is hosted on <a href="http://code.google.com/p/nsm-capture/">google code</a>.</p>
<p><a href="http://creativecommons.org/licenses/by-sa/3.0/us/"><img src="http://i.creativecommons.org/l/by-sa/3.0/us/88x31.png" alt="Creative Commons License"></a>
This work is licensed under a <a href="http://creativecommons.org/licenses/by-sa/3.0/us/">Creative Commons Attribution-Share Alike 3.0 United States License</a>.</p>
<p>Enjoy!</p>

</article>

<div class="post-navigation">
  <ul>
    <li>
      
      <a href="/the-mad-tea-party.html">
        <span class="headline">← Newer article</span>
        <span class="title">The Mad Tea Party</span>
      </a>
      
    </li>
    <li>
      
      <a href="/corporate-brand-mash-up-diy-rebellion.html">
        <span class="headline">Older article →</span>
        <span class="title">Corporate Brand Mash-up DIY Rebellion</span>
      </a>
      
    </li>
  </ul>
</div>

<div class="scroll-up-arrow" tabindex="0">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><g><path class="fillable" d="M990,699.9c0,8.1,0,16.3-8.1,24.4c-16.3,16.3-40.7,16.3-56.9,0L502,350.2L79.1,732.4c-16.3,16.3-40.7,16.3-56.9,0c-16.3-16.3-16.3-40.7,0-56.9l447.3-406.6c24.4-16.3,40.7-16.3,56.9-8.1l447.3,406.6C981.9,675.5,990,691.8,990,699.9z"></path></g></svg>

</div>

      <footer class="footer">
  <div class="container">
    <div class="links">
  
<ul>

</ul>

</div>
    <div class="copyright">
  &copy; 1999-2024 <a href="https://www.gravely.pizza/">gravely</a>
</div>
  </div>
</footer>

    </div>
  </body>
</html>